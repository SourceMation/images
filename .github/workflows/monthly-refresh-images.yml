name: Monthly Refresh Images

on:
# schedule:
#   - cron: '0 8 * * 1' # Runs at 08:00 on the first Monday of the month
  workflow_dispatch: # Allows manual trigger

jobs:
  generate-build-order:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate build order
        run: |
          cd containers
          chmod +x ./docker-build-order.py
          ./docker-build-order.py images/ sourcemation

      - name: Upload build order
        uses: actions/upload-artifact@v4
        with:
          name: build_order
          path: containers/build_order.txt

  build-containers:
    needs: generate-build-order
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download build order
        uses: actions/download-artifact@v4
        with:
          name: build_order

      - name: Read build order
        id: read-build-order
        run: |
          build_order=$(cat build_order.txt)
          echo "::set-output name=build_order::$build_order"

      - name: Build containers
        run: |
          for container in ${{ steps.read-build-order.outputs.build_order }}; do
            echo "Building container: $container"
            gh workflow run build-manual.yml -f container=$container
          done
